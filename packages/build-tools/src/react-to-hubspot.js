import { renderToString } from 'react-dom/server';
import { createElement } from 'react';

/**
 * Render React component to static HTML string for HubSpot templates
 * This enables server-side rendering in HubSpot without duplication
 *
 * @param {Function} Component - React component to render
 * @param {Object} props - Props to pass to component
 * @returns {string} HTML string
 */
export function renderComponentToHTML(Component, props = {}) {
  try {
    const html = renderToString(createElement(Component, props));
    return html;
  } catch (error) {
    console.error(`Failed to render ${Component.displayName || Component.name}:`, error);
    return '';
  }
}

/**
 * Generate HubSpot module HTML that uses React component
 * Creates module.html with server-rendered React + optional hydration
 *
 * @param {Object} options
 * @param {Function} options.Component - React component
 * @param {Array} options.fields - HubSpot fields mapping
 * @param {boolean} options.hydrate - Whether to enable client-side hydration
 * @returns {string} HubL template string
 */
export function generateModuleHTML({ Component, fields, hydrate = false }) {
  const componentName = Component.displayName || Component.name;

  // Build props mapping from HubSpot fields
  const propsMapping = fields
    .map(field => `  "${field.reactProp || field.name}": module.${field.name}`)
    .join(',\n');

  // Generate the HubL template
  let template = `{# React Component: ${componentName} #}\n`;
  template += `{# Server-rendered with optional client-side hydration #}\n\n`;

  if (hydrate) {
    // Interactive component - render with hydration container
    template += `<div class="react-island" data-component="${componentName}"\n`;
    template += `     data-props='{{ {\n${propsMapping}\n     } | tojson }}'>\n`;
    template += `  {# Server-rendered HTML - gets replaced on hydration #}\n`;
    template += `  {% set props = {\n${propsMapping}\n  } %}\n`;
    template += `  {{ render_react_component("${componentName}", props) }}\n`;
    template += `</div>\n`;
  } else {
    // Static component - server-rendered only
    template += `{# Static component - no JavaScript needed #}\n`;
    template += `{% set props = {\n${propsMapping}\n} %}\n`;
    template += `{{ render_react_component("${componentName}", props) }}\n`;
  }

  return template;
}

/**
 * Create HubSpot macro for rendering React components
 * This can be included in HubSpot templates
 *
 * @param {Object} components - Map of component name to React component
 * @returns {string} HubL macro definitions
 */
export function createComponentMacros(components) {
  let macros = `{# React Component Rendering Macros #}\n`;
  macros += `{# Generated by build-tools - DO NOT EDIT MANUALLY #}\n\n`;

  Object.entries(components).forEach(([name, Component]) => {
    macros += `{% macro render_${name}(props) %}\n`;
    macros += `  {# Server-rendered ${name} component #}\n`;
    macros += `  {# Props: {{ props | tojson }} #}\n`;

    // Here we'd need to generate the actual HTML
    // For now, we'll create a placeholder that gets replaced during build
    macros += `  {{ __REACT_SSR_${name.toUpperCase()}__ }}\n`;
    macros += `{% endmacro %}\n\n`;
  });

  return macros;
}
